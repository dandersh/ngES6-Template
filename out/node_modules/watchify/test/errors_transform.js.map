{"version":3,"sources":["../../../../node_modules/watchify/test/errors_transform.js"],"names":[],"mappings":"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","file":"errors_transform.js","sourcesContent":["var test = require('tape');\nvar watchify = require('../');\nvar browserify = require('browserify');\nvar vm = require('vm');\n\nvar fs = require('fs');\nvar path = require('path');\nvar mkdirp = require('mkdirp');\nvar through = require('through2');\n\nvar os = require('os');\nvar tmpdir = path.join((os.tmpdir || os.tmpDir)(), 'watchify-' + Math.random());\n\nvar main = path.join(tmpdir, 'main.js');\nvar file = path.join(tmpdir, 'dep.jsnum');\n\nmkdirp.sync(tmpdir);\nfs.writeFileSync(main, 'require(\"./dep.jsnum\")');\nfs.writeFileSync(file, 'console.log(555)');\n\nfunction someTransform(file) {\n    if (!/\\.jsnum$/.test(file)) {\n        return through();\n    }\n    function write (chunk, enc, next) {\n        if (/\\d/.test(chunk)) {\n            this.push(chunk);\n        } else {\n            this.emit('error', new Error('No number in this chunk'));\n        }\n        next();\n    }\n    return through(write);\n}\n\ntest('errors in transform', function (t) {\n    t.plan(6);\n    var b = browserify(main, watchify.args);\n    b.transform(someTransform);\n    var w = watchify(b);\n    w.bundle(function (err, src) {\n        t.ifError(err);\n        t.equal(run(src), '555\\n');\n        breakTheBuild();\n    });\n    function breakTheBuild() {\n        setTimeout(function() {\n            fs.writeFileSync(file, 'console.log()');\n        }, 1000);\n        w.once('update', function () {\n            w.bundle(function (err, src) {\n                t.ok(err instanceof Error, 'should be error');\n                t.ok(/^No number in this chunk/.test(err.message));\n                fixTheBuild();\n            });\n        });\n    }\n    function fixTheBuild() {\n        setTimeout(function() {\n            fs.writeFileSync(file, 'console.log(333)');\n        }, 1000);\n        var safety = setTimeout(function() {\n            t.fail(\"gave up waiting\");\n            w.close();\n            t.end();\n        }, 5000);\n        w.once('update', function () {\n            clearTimeout(safety);\n            w.bundle(function (err, src) {\n                t.ifError(err);\n                t.equal(run(src), '333\\n');\n                w.close();\n            });\n        });\n    }\n});\n\nfunction run (src) {\n    var output = '';\n    function log (msg) { output += msg + '\\n' }\n    vm.runInNewContext(src, { console: { log: log } });\n    return output;\n}\n"]}